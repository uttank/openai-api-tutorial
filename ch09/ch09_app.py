import uuid
import os
import streamlit as st
from openai import OpenAI
from gpt import get_llm # gpt.pyë¡œë¶€í„° get_llm() í•¨ìˆ˜ë¥¼ ì„í¬íŠ¸.
from ch09.ch09_dalle import get_image_by_dalle # dalle.pyë¡œë¶€í„° get_image_by_dalle() í•¨ìˆ˜ë¥¼ ì„í¬íŠ¸.

# API Key = 
# ê¸°ë³¸ í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title='ğŸ“šNovelGPT',
    layout='wide',
    menu_items={
        'About': "NovelGPT is an interactive storybook experience using ChatGPT and Dalle"
    },
    initial_sidebar_state='expanded'
)

st.title(f"ğŸ“š NovelGPT")

# ìŠ¤í† ë¦¬ ì „ê°œ ì‹œ ê° Partì˜ ë°ì´í„°ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸.
if 'data_dict' not in st.session_state:
    st.session_state['data_dict'] = {}

# ë¬¸ìì—´ ë‚œìˆ˜ë¥¼ ì €ì¥í•  ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸. ìŠ¤í† ë¦¬ ì „ê°œ ì‹œ ê°ê°ì˜ ë‚œìˆ˜ëŠ” ê° Partì˜ Key ê°’ ì—­í• ì„ í•˜ê²Œ ëœë‹¤.
if 'oid_list' not in st.session_state:
    st.session_state['oid_list'] = []

# ì‚¬ìš©ìê°€ OpenAI API Key ê°’ì„ ì‘ì„±í•˜ë©´ ì €ì¥ë˜ëŠ” ì €ì¥ë  ë³€ìˆ˜.
if 'openai_api_key' not in st.session_state:
    st.session_state['openai_api_key'] = ''

# ì‚¬ìš©ìê°€ OpenAI API Key ê°’ì„ ì‘ì„±í•˜ëŠ” ì¹¸ì˜ í™œì„±í™” ì—¬ë¶€. OpenAI Key ê°’ì´ ì…ë ¥ë˜ê¸° ì „ì—ëŠ” ì¹¸ì´ í™œì„±í™”(False) 
if 'apiBox_state' not in st.session_state:
    st.session_state['apiBox_state'] = False

# ì‚¬ìš©ìê°€ ì²« ì‹œì‘ ì‹œ ì£¼ì¸ê³µ ë˜ëŠ” ì¤„ê±°ë¦¬ë¥¼ ì‘ì„±í•˜ë©´ ì €ì¥ë  ë³€ìˆ˜. ê¸°ë³¸ ê°’ì€ 'ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ì˜ ëª¨í—˜'ì´ë‹¤.
if 'genre_input' not in st.session_state:
    st.session_state['genre_input'] = 'ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ì˜ ëª¨í—˜'
    
# ì‚¬ìš©ìê°€ ì²« ì‹œì‘ ì‹œ ì£¼ì¸ê³µ ë˜ëŠ” ì¤„ê±°ë¦¬ë¥¼ ì‘ì„±í•˜ëŠ” ì¹¸ì˜ í™œì„±í™” ì—¬ë¶€. OpenAI Key ê°’ì´ ì…ë ¥ë˜ê¸° ì „ì—ëŠ” ì¹¸ì´ ë¹„í™œì„±í™”(True) 
if 'genreBox_state' not in st.session_state:
    st.session_state['genreBox_state'] = True

# OpenAI API Keyë¥¼ ì¸ì¦í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
def auth():    
    os.environ['OPENAI_API_KEY'] = st.session_state.openai_api_key
    st.session_state.genreBox_state = False

    # APIë¥¼ ì…ë ¥ ì¹¸[ ]ì˜ ìƒíƒœë¥¼ ë°˜ì˜í•˜ëŠ” ë³€ìˆ˜ì…ë‹ˆë‹¤. API Keyë¥¼ ì…ë ¥(Submit ë²„íŠ¼ì„ í´ë¦­)í•˜ë©´ í•´ë‹¹ ì¹¸ì€ ë¹„í™œì„±í™”(True).
    st.session_state.apiBox_state = True

# ì¢Œì¸¡ì˜ ì‚¬ì´ë“œë°” UI
with st.sidebar:
    st.header('ğŸ“š NovelGPT')

    st.markdown('''
    NovelGPTëŠ” ì†Œì„¤ì„ ì‘ì„±í•˜ëŠ” ì¸ê³µì§€ëŠ¥ì…ë‹ˆë‹¤. GPT-4ì™€ Dalleë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤í† ë¦¬ê°€ ì§„í–‰ë©ë‹ˆë‹¤.
    ''')
    
    st.info('**Note:** OpenAI API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.')

    # OpenAI Key ê°’ì„ ì…ë ¥í•˜ëŠ” ì¹¸.
    with st.form(key='API Keys'):
        openai_key = st.text_input(
            label='OpenAI API Key', 
            key='openai_api_key',
            type='password', # ì…ë ¥ ì‹œì— ê°’ì´ í™”ë©´ì— ë³´ì´ì§€ ì•Šê³  **ë¡œ í‘œì‹œë˜ë„ë¡ í•œë‹¤.
            disabled=st.session_state.apiBox_state, # í™œì„±í™” ì—¬ë¶€ ë³€ìˆ˜ë¡œ apiBox_stateë¥¼ ì‚¬ìš©.
            help='OpenAI API keyì€ https://platform.openai.com/account/api-keys ì—ì„œ ë°œê¸‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
        )
        
        btn = st.form_submit_button(label='Submit', on_click=auth)

    with st.expander('ì‚¬ìš© ê°€ì´ë“œ'):
        st.markdown('''
        - ìœ„ì˜ ì…ë ¥ ì¹¸ì— <OpenAI API Key>ë¥¼ ì‘ì„± í›„ [Submit] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”. 
        - ê·¸ í›„ ìš°ì¸¡ í™”ë©´ì— ì£¼ì œë‚˜ ì£¼ì¸ê³µì— ëŒ€í•œ ì„œìˆ ì„ ë¬˜ì‚¬í•˜ê³  [ì‹œì‘!] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
        - ìŠ¤í† ë¦¬ê°€ ì‹œì‘ë˜ë©´ ì„ íƒì§€ë¥¼ ëˆ„ë¥´ë©° ë‚´ìš©ì„ ì „ê°œí•©ë‹ˆë‹¤.
        ''')        

    with st.expander('ë” ë§ì€ ì˜ˆì‹œ ë³´ëŸ¬ê°€ê¸°'):
        st.write('[ë² ìŠ¤íŠ¸ì…€ëŸ¬! ì§„ì§œ ì±—GPT API í™œìš©ë²•](https://www.yes24.com/Product/Goods/121773683)')

# ì‹œì‘ ì‹œ OpenAI API Keyê°’ì´ ì…ë ¥ë˜ì§€ ì•Šì€ ê²½ìš° ê²½ê³  ë¬¸êµ¬ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
if not openai_key.startswith('sk-'): 
    st.warning('OpenAI API Keyê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', icon='âš ')

# í™”ë©´ì— ì¶œë ¥í•  ìŠ¤í† ë¦¬, ì§ˆë¬¸, ì„ íƒì§€, ì´ë¯¸ì§€ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜.
def get_story_and_image(user_choice):
    # user_choiceëŠ” ì´ì „ ì„ íƒì§€ì—ì„œ ì‚¬ìš©ìê°€ ì„ íƒí•œ ë³´ê¸°ê°€ ë¬¸ìì—´ë¡œ ì €ì¥ë˜ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.
    # ex) D. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ì‹œ ì„œë¡œë¥¼ ë•ëŠ” ì‘ê¸‰ ëŒ€ì‘ íŒ€ì„ êµ¬ì„±í•˜ìê³  ì œì•ˆí•œë‹¤.

    # Dalle ì‚¬ìš©ì„ ìœ„í•´ client ê°ì²´ë¥¼ ì„ ì–¸. ì´í›„ get_image_by_dalle()ì— ì „ë‹¬.
    # get_llm(): ìŠ¤í† ë¦¬ ì „ê°œë¥¼ ìœ„í•´ ChatGPT ì…‹íŒ…í•˜ëŠ” í•¨ìˆ˜. í”„ë¡¬í”„íŠ¸ë„ ì‘ì„±ë˜ì–´ì ¸ ìˆìŒ.
    client = OpenAI()
    llm_model = get_llm()

    # ì‚¬ìš©ìì˜ ì„ íƒì§€ì¸ user_choiceë¡œë¶€í„° LLMì´ ì‘ì„±í•œ ë‹¤ìŒ ìŠ¤í† ë¦¬, ë‹¤ìŒ ì„ íƒì§€ 4ê°œ, Dalle í”„ë¡¬í”„íŠ¸ë¥¼ ì „ë‹¬ë°›ìŠµë‹ˆë‹¤.
    llm_generation_result = llm_model.predict(input=user_choice)

    # ì•„ë˜ëŠ” llm_generation_resultì˜ ì˜ˆì‹œì…ë‹ˆë‹¤.
    # ==============================================================================
    # ë³´ë¬¼ì´ëŠ” ì–´ë¥¸ í­ê·„ë“¤ ì‚¬ì´ì—ì„œ ìš©ê°í•˜ê²Œ ë°œê±¸ìŒì„ ì˜®ê²¼ë‹¤. ê·¸ì˜ ì‘ì€ ëª©ì†Œë¦¬ê°€ í¬ë§ê³¼ ì—´ì •ì„ ë‹´ì•„ ë©”ì•„ë¦¬ì³¤ë‹¤. "ìš°ë¦¬ê°€ ì„œë¡œ  í˜‘ë ¥í•´ì„œ, ëˆˆì‚¬íƒœì— ëŒ€ë¹„í•œë‹¤ë©´ ëª¨ë‘ê°€ ë” ì•ˆì „í•  ìˆ˜ ìˆì–´ìš”!" ì–´ë¥¸ í­ê·„ë“¤ì€ ë¨¼ì € ì˜ì‹¬ì˜ ëˆˆì´ˆë¦¬ë¥¼ ë³´ëƒˆìœ¼ë‚˜, ë³´ë¬¼ì´ì˜ ì§„ì‹¬ì´ ë‹´ê¸´ ëˆˆë¹›ê³¼ ìì‹ ê° ìˆëŠ” ì œì•ˆì— ì¡°ê¸ˆì”© ë§ˆìŒì„ ì—´ê¸° ì‹œì‘í–ˆë‹¤. 

    # íšŒì˜ ì¥ì†ŒëŠ” ê¸´ì¥ê³¼ ê¸°ëŒ€ê°ìœ¼ë¡œ ê°€ë“ ì°¼ê³ , ë§ì€ í­ê·„ë“¤ì´ ë³´ë¬¼ì´ì˜ ì£¼ë³€ìœ¼ë¡œ ëª¨ì—¬ë“¤ì—ˆë‹¤.
    
    # ì–´ë¦° ë³´ë¬¼ì´ê°€ ëˆˆì‚¬íƒœ ëŒ€ë¹„ ê³„íšì„ ì†Œìƒíˆ ì„¤ëª…í•˜ì, ì–´ë¥¸ë“¤ì€ ì´ì œ ê·¸ì˜ ë§ì— ê·€ë¥¼ ê¸°ìš¸ì˜€ë‹¤. í­ê·„ ì‚¬íšŒì—ì„œëŠ” ì–´ë¦° í­ê·„ì˜ ëª©ì†Œë¦¬ê°€ ìì£¼ ë¬»íˆê³¤ í•˜ì˜€ìœ¼ë‚˜, ì˜¤ëŠ˜ì€ ê·¸ê°€ ì£¼ì¸ê³µì´ ë˜ì—ˆë‹¤. 

    # -- -- --

    # A. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ë°œìƒ ì‹œ ëŒ€í”¼í•  ìˆ˜ ìˆëŠ” ì•ˆì „ ì§€ëŒ€ë¥¼ ì œì‹œí•œë‹¤.

    # B. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ê°ì§€ë¥¼ ìœ„í•œ ê²½ë³´ ì‹œìŠ¤í…œì„ ì„¤ê³„í•´ë³´ìê³  ì œì•ˆí•œë‹¤.

    # C. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ í›ˆë ¨ì„ ì •ê¸°ì ìœ¼ë¡œ ì‹¤ì‹œí•  ê²ƒì„ ê¶Œí•œë‹¤.

    # D. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ì‹œ ì„œë¡œë¥¼ ë•ëŠ” ì‘ê¸‰ ëŒ€ì‘ íŒ€ì„ êµ¬ì„±í•˜ìê³  ì œì•ˆí•œë‹¤.

    # ì„ íƒì§€: ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”?

    # -- -- --

    # Dalle Prompt Start! ëˆˆ ë®ì¸ ëŒ€ê·œëª¨ í­ê·„ ì„œì‹ì§€ì˜ ì¤‘ì•™ ê´‘ì¥ì—ì„œ, ì‘ê³  ìš©ê°í•œ ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ê°€ ë‹¤ë¥¸ í­ê·„ë“¤ì—ê²Œ ë‘˜ëŸ¬ì‹¸ì—¬ ì„œ ìˆë‹¤. ë³´ë¬¼ì´ëŠ” í­ê·„ ëŒ€ì¤‘ë“¤ì—ê²Œ ëˆˆì‚¬íƒœ ëŒ€ë¹„ ê³„íšì„ ì œì•ˆí•˜ê³  ìˆìœ¼ë©°, ì£¼ì˜ ê¹Šê²Œ ë“£ê³  ìˆëŠ” ë‹¤ì–‘í•œ ìƒê¹€ìƒˆì˜ ì–´ë¥¸ í­ê·„ë“¤ë¡œ ê´‘ì¥ì´ ì±„ì›Œì ¸ ìˆë‹¤. 
    # ==============================================================================

    # ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì˜ llm_generation_resultë¥¼ ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜. ì´ë ‡ê²Œ ë˜ë©´ ë§ˆì§€ë§‰ ì¤„ì€ Dalle Promptì´ë‹¤.
    # ex) [ìŠ¤í† ë¦¬ ë¬¸ì¥1, ìŠ¤í† ë¦¬ ë¬¸ì¥2, -- -- --, Aì„ íƒì§€, Bì„ íƒì§€, Cì„ íƒì§€, Dì„ íƒì§€, -- -- --, ë‹¬ë¦¬ í”„ë¡¬í”„íŠ¸]
    response_list = llm_generation_result.split("\n")
    
    if len(response_list) != 1:
        # ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë§ˆì§€ë§‰ ì›ì†Œë¥¼ ì¶”ì¶œí•˜ë©´ ë‹¬ë¦¬ í”„ë¡¬í”„íŠ¸ì´ë‹¤.
        # =========================
        # ex) img_prompt =
        # 'Dalle Prompt Start! ëˆˆ ë®ì¸ ëŒ€ê·œëª¨ í­ê·„ ì„œì‹ì§€ì˜ ì¤‘ì•™ ê´‘ì¥ì—ì„œ, ì‘ê³  ìš©ê°í•œ ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ê°€ ë‹¤ë¥¸ í­ê·„ë“¤ì—ê²Œ ë‘˜ëŸ¬ì‹¸ì—¬ ì„œ ìˆë‹¤. ë³´ë¬¼ì´ëŠ” í­ê·„ ëŒ€ì¤‘ë“¤ì—ê²Œ ëˆˆì‚¬íƒœ ëŒ€ë¹„ ê³„íšì„ ì œì•ˆí•˜ê³  ìˆìœ¼ë©°, ì£¼ì˜ ê¹Šê²Œ ë“£ê³  ìˆëŠ” ë‹¤ì–‘í•œ ìƒê¹€ìƒˆì˜ ì–´ë¥¸ í­ê·„ë“¤ë¡œ ê´‘ì¥ì´ ì±„ì›Œì ¸ ìˆë‹¤.'
        # =========================
        img_prompt = response_list[-1]
        dalle_img = get_image_by_dalle(client, img_prompt)
    else:
        dalle_img = None
        
    choices = []
    story = ''

    # ê³µë°±, ë¹ˆ ê°’, '-- -- --'ê³¼ ê°™ì€ ë¬´ì˜ë¯¸í•œ ê°’ê³¼ Dalle Prompt ë“±ì€ ì œì™¸í•˜ê³ 
    # ë©”ì¸ ìŠ¤í† ë¦¬(story), ì§ˆë¬¸(decisionQuestion), ì„ íƒì§€(choices)ë§Œ responsesì˜ ì›ì†Œë¡œ ë‚¨ê¸´ë‹¤.
    responses = list(filter(lambda x: x != '' and x != '-- -- --', response_list))
    responses = list(filter(lambda x: 'Dalle Prompt' not in x and 'Image prompt' not in x, responses))
    responses = [s for s in responses if s.strip()]

    # ì „ì²˜ë¦¬ë¥¼ ê±°ì¹œ í›„ì˜ responses ì˜ˆì‹œ
    # ìŠ¤í† ë¦¬, ì„ íƒì§€, ì„ íƒì§€ ì§ˆë¬¸ì´ ìˆœì°¨ì ìœ¼ë¡œ ë“¤ì–´ê°€ ìˆëŠ” ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸.
    # =========================
    # ex) responses = 
    # ['ë³´ë¬¼ì´ëŠ” ì–´ë¥¸ í­ê·„ë“¤ ì‚¬ì´ì—ì„œ ìš©ê°í•˜ê²Œ ë°œê±¸ìŒì„ ì˜®ê²¼ë‹¤. ê·¸ì˜ ì‘ì€ ëª©ì†Œë¦¬ê°€ í¬ë§ê³¼ ì—´ì •ì„ ë‹´ì•„ ë©”ì•„ë¦¬ì³¤ë‹¤. "ìš°ë¦¬ê°€ ì„œë¡œ  í˜‘ë ¥í•´ì„œ, ëˆˆì‚¬íƒœì— ëŒ€ë¹„í•œë‹¤ë©´ ëª¨ë‘ê°€ ë” ì•ˆì „í•  ìˆ˜ ìˆì–´ìš”!" ì–´ë¥¸ í­ê·„ë“¤ì€ ë¨¼ì € ì˜ì‹¬ì˜ ëˆˆì´ˆë¦¬ë¥¼ ë³´ëƒˆìœ¼ë‚˜, ë³´ë¬¼ì´ì˜ ì§„ì‹¬ì´ ë‹´ê¸´ ëˆˆë¹›ê³¼ ìì‹ ê° ìˆëŠ” ì œì•ˆì— ì¡°ê¸ˆì”© ë§ˆìŒì„ ì—´ê¸° ì‹œì‘í–ˆë‹¤.',
    # 'íšŒì˜ ì¥ì†ŒëŠ” ê¸´ì¥ê³¼ ê¸°ëŒ€ê°ìœ¼ë¡œ ê°€ë“ ì°¼ê³ , ë§ì€ í­ê·„ë“¤ì´ ë³´ë¬¼ì´ì˜ ì£¼ë³€ìœ¼ë¡œ ëª¨ì—¬ë“¤ì—ˆë‹¤.',
    # 'ì–´ë¦° ë³´ë¬¼ì´ê°€ ëˆˆì‚¬íƒœ ëŒ€ë¹„ ê³„íšì„ ì†Œìƒíˆ ì„¤ëª…í•˜ì, ì–´ë¥¸ë“¤ì€ ì´ì œ ê·¸ì˜ ë§ì— ê·€ë¥¼ ê¸°ìš¸ì˜€ë‹¤. í­ê·„ ì‚¬íšŒì—ì„œëŠ” ì–´ë¦° í­ê·„ì˜ ëª©ì†Œë¦¬ê°€ ìì£¼ ë¬»íˆê³¤ í•˜ì˜€ìœ¼ë‚˜, ì˜¤ëŠ˜ì€ ê·¸ê°€ ì£¼ì¸ê³µì´ ë˜ì—ˆë‹¤.',
    # 'A. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ë°œìƒ ì‹œ ëŒ€í”¼í•  ìˆ˜ ìˆëŠ” ì•ˆì „ ì§€ëŒ€ë¥¼ ì œì‹œí•œë‹¤.',
    # 'B. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ê°ì§€ë¥¼ ìœ„í•œ ê²½ë³´ ì‹œìŠ¤í…œì„ ì„¤ê³„í•´ë³´ìê³  ì œì•ˆí•œë‹¤.',
    # 'C. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ í›ˆë ¨ì„ ì •ê¸°ì ìœ¼ë¡œ ì‹¤ì‹œí•  ê²ƒì„ ê¶Œí•œë‹¤.',
    # 'D. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ì‹œ ì„œë¡œë¥¼ ë•ëŠ” ì‘ê¸‰ ëŒ€ì‘ íŒ€ì„ êµ¬ì„±í•˜ìê³  ì œì•ˆí•œë‹¤.',
    # 'ì„ íƒì§€: ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”?']
    # =========================
    
    # ë©”ì¸ ìŠ¤í† ë¦¬(story), ì§ˆë¬¸(decisionQuestion), ì„ íƒì§€(choices)ë¥¼ íŒŒì‹±í•˜ì—¬ ê°ê° ì €ì¥.
    for response in responses:
        response = response.strip()
        # í™”ë©´ì— ì¶œë ¥í•  ì„ íƒì§€ ì§ˆë¬¸ì„ íŒŒì‹±í•˜ê³  ì–‘ ì˜†ì— **ë¥¼ ë¶™ì—¬ì„œ decisionQuestionì— ì €ì¥í•©ë‹ˆë‹¤.
        # =========================
        # ex) decisionQuestion = **ì„ íƒì§€: ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”?'**
        # =========================
        if response.startswith('ì„ íƒì§€:'):
            decisionQuestion = '**' + response + '**'
        
        # ì•„ë˜ëŠ” choicesì— ëŒ€í•œ ì„¤ëª…ì…ë‹ˆë‹¤.
        # ì‹¤ì œ ì„ íƒì§€ 4ê°œëŠ” ì•ŒíŒŒë²³ê³¼ ì˜¨ì ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.
        # ex) A. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ë°œìƒ ì‹œ ëŒ€í”¼í•  ìˆ˜ ìˆëŠ” ì•ˆì „ ì§€ëŒ€ë¥¼ ì œì‹œí•œë‹¤.
        # ë”°ë¼ì„œ ë¬¸ì¥ ì¤‘ ì²«ë²ˆì§¸ ì›ì†Œê°€ ì˜¨ì ì¸ ì ì„ ì´ìš©í•˜ì—¬ íŒŒì‹±í•˜ê³  ê° ì„ íƒì§€ë¥¼ ëª¨ë‘ íŒŒì‹±í•˜ì—¬ choicesì— ëˆ„ì  ì €ì¥í•©ë‹ˆë‹¤.
        # ë°˜ë³µë¬¸ì„ ëª¨ë‘ ëŒê³ ë‚œ í›„ì˜ choicesì˜ ê²°ê³¼ ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
        # =========================
        # ex) choices =
        # ['A. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ë°œìƒ ì‹œ ëŒ€í”¼í•  ìˆ˜ ìˆëŠ” ì•ˆì „ ì§€ëŒ€ë¥¼ ì œì‹œí•œë‹¤.',
        #  'B. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ê°ì§€ë¥¼ ìœ„í•œ ê²½ë³´ ì‹œìŠ¤í…œì„ ì„¤ê³„í•´ë³´ìê³  ì œì•ˆí•œë‹¤.',
        #  'C. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ í›ˆë ¨ì„ ì •ê¸°ì ìœ¼ë¡œ ì‹¤ì‹œí•  ê²ƒì„ ê¶Œí•œë‹¤.',
        #  'D. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ì‹œ ì„œë¡œë¥¼ ë•ëŠ” ì‘ê¸‰ ëŒ€ì‘ íŒ€ì„ êµ¬ì„±í•˜ìê³  ì œì•ˆí•œë‹¤.']
        # =========================
        elif response[1] == '.':
            choices.append(response) 
        # ì§ˆë¬¸(decisionQuestion)ê³¼ ì„ íƒì§€(choices)ê°€ ì•„ë‹ˆë¼ë©´ ë‚¨ëŠ” ê²ƒì€ ë©”ì¸ ìŠ¤í† ë¦¬ì´ë¯€ë¡œ storyì— ì €ì¥.
        else:
            story += response + '\n'

    # ìŠ¤í† ë¦¬ì— ì˜ˆìƒì¹˜ ëª»í•˜ê²Œ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ê°€ ì—¬ì „íˆ ë‚¨ì•„ìˆì„ ê²½ìš° ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ëŠ” ì œê±°
    # =========================
    # ex) story =
    # 'ë³´ë¬¼ì´ëŠ” ì–´ë¥¸ í­ê·„ë“¤ ì‚¬ì´ì—ì„œ ìš©ê°í•˜ê²Œ ë°œê±¸ìŒì„ ì˜®ê²¼ë‹¤. ê·¸ì˜ ì‘ì€ ëª©ì†Œë¦¬ê°€ í¬ë§ê³¼ ì—´ì •ì„ ë‹´ì•„ ë©”ì•„ë¦¬ì³¤ë‹¤. "ìš°ë¦¬ê°€ ì„œë¡œ  í˜‘ë ¥í•´ì„œ, ëˆˆì‚¬íƒœì— ëŒ€ë¹„í•œë‹¤ë©´ ëª¨ë‘ê°€ ë” ì•ˆì „í•  ìˆ˜ ìˆì–´ìš”!" ì–´ë¥¸ í­ê·„ë“¤ì€ ë¨¼ì € ì˜ì‹¬ì˜ ëˆˆì´ˆë¦¬ë¥¼ ë³´ëƒˆìœ¼ë‚˜, ë³´ë¬¼ì´ì˜ ì§„ì‹¬ì´ ë‹´ê¸´ ëˆˆë¹›ê³¼ ìì‹ ê° ìˆëŠ” ì œì•ˆì— ì¡°ê¸ˆì”© ë§ˆìŒì„ ì—´ê¸° ì‹œì‘í–ˆë‹¤. íšŒì˜ ì¥ì†ŒëŠ” ê¸´ì¥ê³¼ ê¸°ëŒ€ê°ìœ¼ë¡œ ê°€ë“ ì°¼ê³ , ë§ì€ í­ê·„ë“¤ì´ ë³´ë¬¼ì´ì˜ ì£¼ë³€ìœ¼ë¡œ ëª¨ì—¬ë“¤ì—ˆë‹¤. ì–´ë¦° ë³´ë¬¼ì´ê°€ ëˆˆì‚¬íƒœ ëŒ€ë¹„ ê³„íšì„ ì†Œìƒíˆ ì„¤ëª…í•˜ì, ì–´ë¥¸ë“¤ì€ ì´ì œ ê·¸ì˜ ë§ì— ê·€ë¥¼ ê¸°ìš¸ì˜€ë‹¤. í­ê·„ ì‚¬íšŒì—ì„œëŠ” ì–´ë¦° í­ê·„ì˜ ëª©ì†Œë¦¬ê°€ ìì£¼ ë¬»íˆê³¤ í•˜ì˜€ìœ¼ë‚˜, ì˜¤ëŠ˜ì€ ê·¸ê°€ ì£¼ì¸ê³µì´ ë˜ì—ˆë‹¤.'
    # =========================
    story = story.replace(img_prompt, '')
    return {
        'story': story, # í™”ë©´ì— ì¶œë ¥í•  ìŠ¤í† ë¦¬
        'decisionQuestion': decisionQuestion, # í™”ë©´ì— ì¶œë ¥í•  ì§ˆë¬¸. 'ë‹¤ìŒì€ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”?'
        'choices': choices, # í™”ë©´ì— ì¶œë ¥í•  ì‹¤ì œ 4ê°œì˜ ì„ íƒì§€.
        'dalle_img': dalle_img # í™”ë©´ì— ì¶œë ¥í•  ë‹¬ë¦¬ ì´ë¯¸ì§€
    }

# ì•„ë˜ì˜ í•¨ìˆ˜ëŠ” [ì‹œì‘!] ë²„íŠ¼ ë˜ëŠ” [ì§„í–‰í•˜ê¸°] ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜.
# ì‚¬ìš©ìê°€ ì„ íƒí•œ ì„ íƒì§€ë¥¼ ì „ë‹¬í•˜ì—¬ get_story_and_image() í•¨ìˆ˜ë¥¼ í˜¸ì¶œ.
# get_story_and_image() í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ gpt-4ì™€ Dalleë¥¼ í˜¸ì¶œí•˜ì—¬ ë‹¤ìŒ ìŠ¤í† ë¦¬ì™€ ì´ë¯¸ì§€ ìƒì„±.
@st.cache_data(experimental_allow_widgets=True, show_spinner='Generating your story...')
def get_output(_pos: st.empty, oid='', genre=''):

    # ì•„ë˜ì˜ ifë¬¸ì€ ì²˜ìŒ [ì‹œì‘!] ë²„íŠ¼ì—ëŠ” ë™ì‘í•˜ì§€ ì•Šìœ¼ë©° ì„ íƒì§€ë¥¼ í´ë¦­í•˜ê³  [ì§„í–‰í•˜ê¸°] ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ë™ì‘í•œë‹¤.
    if oid:
        # ì„ íƒì§€ë¥¼ í´ë¦­í•˜ëŠ” ìˆœê°„ í˜„ ì‹œì ì—ì„œì˜ Partì—ì„œì˜ ì„¤ì •ê°’ì„ ì „ë¶€ ë³€ê²½í•œë‹¤.
        # ì˜ˆë¥¼ ë“¤ì–´ Part 2ì—ì„œ Part 3ìœ¼ë¡œ ê°€ê¸°ìœ„í•´ì„œ ì„ íƒì§€ë¥¼ í´ë¦­í•˜ëŠ” ìˆœê°„
        # get_output() í•¨ìˆ˜ê°€ Part 2ì˜ oidë¡œ í˜¸ì¶œë˜ë©´ì„œ Part 2ì˜ ë²„íŠ¼ë“¤ì´ ì „ë¶€ ë¹„í™œì„±í™” ë˜ê¸° ìœ„í•´ì„œ ì´ ê°’ë“¤ì´ ì…‹íŒ…ëœë‹¤.
        st.session_state['genreBox_state'] = True
        st.session_state[f'expanded_{oid}'] = False # í¼ì³ì¡Œë˜ ê²ƒì„ ë‹«ê¸° ìœ„í•œ ê°’
        st.session_state[f'radio_{oid}_disabled'] = True # ë¼ë””ì˜¤ ë²„íŠ¼ì„ ë‹«ê¸° ìœ„í•œ ê°’
        st.session_state[f'submit_{oid}_disabled'] = True # ì§„í–‰í•˜ê¸° ë²„íŠ¼ì„ ë‹«ê¸° ìœ„í•œ ê°’

        # ë°©ê¸ˆ ì„ íƒí•œ ì„ íƒì§€ì—ì„œì˜ ê°’ì„ ì €ì¥.
        user_choice = st.session_state[f'radio_{oid}']
    
    # ì²˜ìŒ ì‹œì‘í•  ë•ŒëŠ” ì‚¬ìš©ìì˜ ì„ íƒì´ ë”°ë¡œ ì—†ìœ¼ë¯€ë¡œ user_choiceì— ì‚¬ìš©ìê°€ ì ì€ ì œëª©ì´ ì €ì¥ë¨.
    if genre:         
        st.session_state['genreBox_state'] = False
        user_choice = genre
    
    with _pos:
        # ì‚¬ìš©ìì˜ ì„ íƒì§€ë¡œë¶€í„° ìŠ¤í† ë¦¬ì™€ ì´ë¯¸ì§€ë¥¼ ë°›ì•„ë‚¸ë‹¤.
        data = get_story_and_image(user_choice)
        # data ë‚´ë¶€ êµ¬ì¡°
        # 'story': í™”ë©´ì— ì¶œë ¥í•  ìŠ¤í† ë¦¬
        # 'decisionQuestion': í™”ë©´ì— ì¶œë ¥í•  ì§ˆë¬¸. 'ë‹¤ìŒì€ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”?'
        # 'choices': í™”ë©´ì— ì¶œë ¥í•  ì‹¤ì œ 4ê°œì˜ ì„ íƒì§€.
        # 'dalle_img': í™”ë©´ì— ì¶œë ¥í•  ë‹¬ë¦¬ ì´ë¯¸ì§€
        add_new_data(data['story'], data['decisionQuestion'], data['choices'], data['dalle_img'])
        
# í™”ë©´ì— ê° Partë¥¼ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
def generate_content(story, decisionQuestion, choices: list, img, oid):
    # ì•„ë˜ì˜ ifë¬¸ 3ê°œëŠ” ì´ë¯¸ ì‹¤í–‰ëœ ì ì´ ìˆì—ˆë˜ oid(Part / ìŠ¤í† ë¦¬)ì—ì„œëŠ” ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë©°
    # ìƒˆë¡­ê²Œ ì¶œë ¥ë˜ì–´ì•¼ í•˜ëŠ” 'ì§€ê¸ˆì˜' oid(Part / ìŠ¤í† ë¦¬)ì˜ ê²½ìš°ì—ë§Œ ì „ë¶€ ì¡°ê±´ë¬¸ì´ Trueê°€ ë˜ì–´ ì‹¤í–‰ëœë‹¤.
    # ê³¼ê±°ì— ì¶œë ¥ëœ ì ì´ ìˆë˜ oid(Part / ìŠ¤í† ë¦¬ëŠ”) get_output() í•¨ìˆ˜ì˜ ì²« ì¡°ê±´ë¬¸ì—ì„œ st.session_stateì— ê¸°ë¡ë˜ì—ˆê¸° ë•Œë¬¸ì— ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.
    if f'expanded_{oid}' not in st.session_state:
        st.session_state[f'expanded_{oid}'] = True # ìƒˆë¡œìš´ ìŠ¤í† ë¦¬ë¥¼ í¼ì¹˜ê¸° ìœ„í•œ ê°’
    if f'radio_{oid}_disabled' not in st.session_state:
        st.session_state[f'radio_{oid}_disabled'] = False # 4ê°œì˜ ì„ íƒì§€ë¥¼ ì„ íƒí•˜ëŠ” ë¼ë””ì˜¤ ë²„íŠ¼ì„ ì—´ê¸° ìœ„í•œ ê°’
    if f'submit_{oid}_disabled' not in st.session_state:
        st.session_state[f'submit_{oid}_disabled'] = False # ì§„í–‰í•˜ê¸° ë²„íŠ¼ì„ ì—´ê¸° ìœ„í•œ ê°’
    
    # í™”ë©´ì— ê° ìŠ¤í† ë¦¬ íŒŒíŠ¸ê°€ ì¶œë ¥ë  ë•Œ, 'Part ìˆ«ì'ì—ì„œì˜ ìˆ«ìë¥¼ ê³„ì‚°í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤. ìˆ«ìëŠ” ê³„ì† 1ì”© ì¦ê°€í•©ë‹ˆë‹¤.
    story_pt = list(st.session_state["data_dict"].keys()).index(oid) + 1

    # ê° ìŠ¤í† ë¦¬ëŠ” 'Part ìˆ«ì' í˜•íƒœë¡œ í™”ë©´ì— ì¶œë ¥ë˜ë©° ê° PartëŠ” expanded_{oid}ì˜ ê°’ì— ë”°ë¼ ì—´ë¦¬ê±°ë‚˜ ë‹«í™ë‹ˆë‹¤.
    expander = st.expander(f'Part {story_pt}', expanded=st.session_state[f'expanded_{oid}'])
    col1, col2 = expander.columns([0.65, 0.35])
    empty = st.empty()

    # col2ëŠ” ìŠ¤í† ë¦¬ ì§„í–‰ ì¤‘ì— í‘œì‹œë  ìš°ì¸¡ í™”ë©´ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ìš°ì¸¡ í™”ë©´ì— Dalleê°€ ìƒì„±í•œ ì´ë¯¸ì§€ë¥¼ í‘œí˜„í•©ë‹ˆë‹¤.
    if img:
        col2.image(img, width=40, use_column_width='always')
    
    # col1ì€ ìŠ¤í† ë¦¬ ì§„í–‰ ì¤‘ì— í‘œì‹œë  ì¢Œì¸¡ í™”ë©´ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
    with col1:
        # storyëŠ” í™”ë©´ì— ì¶œë ¥ë  ë©”ì¸ ìŠ¤í† ë¦¬ì…ë‹ˆë‹¤.
        # ex) ë³´ë¬¼ì´ëŠ” ì–´ë¥¸ í­ê·„ë“¤ ì‚¬ì´ì—ì„œ ìš©ê°í•˜ê²Œ ë°œê±¸ìŒì„ ì˜®ê²¼ë‹¤. ê·¸ì˜ ì‘ì€ ëª©ì†Œë¦¬ê°€ í¬ë§ê³¼ ì—´ì •ì„ ë‹´ì•„ ë©”ì•„ë¦¬ì³¤ë‹¤. "ìš°ë¦¬ê°€ ì„œë¡œ  í˜‘ë ¥í•´ì„œ, ëˆˆì‚¬íƒœì— ëŒ€ë¹„í•œë‹¤ë©´ ëª¨ë‘ê°€ ë” ì•ˆì „í•  ìˆ˜ ìˆì–´ìš”!" ì–´ë¥¸ í­ê·„ë“¤ì€ ë¨¼ì € ì˜ì‹¬ì˜ ëˆˆì´ˆë¦¬ë¥¼ ë³´ëƒˆìœ¼ë‚˜, ë³´ë¬¼ì´ì˜ ì§„ì‹¬ì´ ë‹´ê¸´ ëˆˆë¹›ê³¼ ìì‹ ê° ìˆëŠ” ì œì•ˆì— ì¡°ê¸ˆì”© ë§ˆìŒì„ ì—´ê¸° ì‹œì‘í–ˆë‹¤. 
        st.write(story)
        
        # choicesëŠ” ê° ì„ íƒì§€ê°€ ì €ì¥ëœ ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
        # ex)
        # ['A. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ë°œìƒ ì‹œ ëŒ€í”¼í•  ìˆ˜ ìˆëŠ” ì•ˆì „ ì§€ëŒ€ë¥¼ ì œì‹œí•œë‹¤.',
        #  'B. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ê°ì§€ë¥¼ ìœ„í•œ ê²½ë³´ ì‹œìŠ¤í…œì„ ì„¤ê³„í•´ë³´ìê³  ì œì•ˆí•œë‹¤.',
        #  'C. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ í›ˆë ¨ì„ ì •ê¸°ì ìœ¼ë¡œ ì‹¤ì‹œí•  ê²ƒì„ ê¶Œí•œë‹¤.',
        #  'D. ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ëˆˆì‚¬íƒœ ì‹œ ì„œë¡œë¥¼ ë•ëŠ” ì‘ê¸‰ ëŒ€ì‘ íŒ€ì„ êµ¬ì„±í•˜ìê³  ì œì•ˆí•œë‹¤.']

        # decisionQuestionëŠ” í™”ë©´ì— ì¶œë ¥ë˜ëŠ” ì§ˆë¬¸ì…ë‹ˆë‹¤.
        # ex)
        # **ì„ íƒì§€: ì•„ê¸° í­ê·„ ë³´ë¬¼ì´ëŠ” ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”?**

        # ì§ˆë¬¸(decisionQuestion)ê³¼ ì„ íƒì§€(choices)ê°€ ì •ìƒì ìœ¼ë¡œ ìˆëŠ” ìƒí™©ì´ë¼ë©´
        # ê° ì„ íƒì§€ì— ì„ íƒí•  ìˆ˜ ìˆëŠ” radio ë²„íŠ¼ê³¼ 'ì§„í–‰í•˜ê¸°'ë¼ëŠ” submit ë²„íŠ¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
        if decisionQuestion and choices:
            with st.form(key=f'user_choice_{oid}'): 
                st.radio(decisionQuestion, choices, disabled=st.session_state[f'radio_{oid}_disabled'], key=f'radio_{oid}')
                # ì§„í–‰í•˜ê¸° ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ get_output í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
                # ë§Œì•½, ì´ë¯¸ ì§„í–‰ë˜ì—ˆë˜ Partë¼ë©´ disabled ê°’ì´ Trueê°€ ë˜ì–´ì„œ ì§„í–‰í•˜ê¸° ë²„íŠ¼ì„ í™œì„±í™”ë©ë‹ˆë‹¤.
                st.form_submit_button(
                    label="ì§„í–‰í•˜ê¸°", 
                    disabled=st.session_state[f'submit_{oid}_disabled'], 
                    on_click=get_output, args=[empty], kwargs={'oid': oid}
                )


def add_new_data(*data):
    '''
    data ë‚´ë¶€ êµ¬ì¡°
    'story': í™”ë©´ì— ì¶œë ¥í•  ìŠ¤í† ë¦¬
    'decisionQuestion': í™”ë©´ì— ì¶œë ¥í•  ì§ˆë¬¸. 'ë‹¤ìŒì€ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”?'
    'choices': í™”ë©´ì— ì¶œë ¥í•  ì‹¤ì œ 4ê°œì˜ ì„ íƒì§€.
    'dalle_img': í™”ë©´ì— ì¶œë ¥í•  ë‹¬ë¦¬ ì´ë¯¸ì§€
    '''
    # uuid.uuid4() ì½”ë“œë¥¼ í™œìš©í•˜ì—¬ ì„ì˜ì˜ ë‚œìˆ˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    # ex) oid = fd5198c7-67a5-4fc9-83ad-56afc16e2d6a
    oid = str(uuid.uuid4())

    # ìƒˆë¡œìš´ partì˜ oid ê°’ì„ ì´ì „ partì˜ oid ê°’ë“¤ì´ ì €ì¥ë˜ì–´ì ¸ ìˆëŠ” ë¦¬ìŠ¤íŠ¸ì— ëˆ„ì í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
    st.session_state['oid_list'].append(oid)

    # data_dictì— oidë¥¼ key ê°’ìœ¼ë¡œ í˜„ì¬ partì˜ ë°ì´í„°ë¥¼ ì €ì¥.
    st.session_state['data_dict'][oid] = data
    
# Genre Input widgets
with st.container():
    col_1, col_2, col_3 = st.columns([8, 1, 1], gap='small')
    
    col_1.text_input(
        label='Enter the theme/genre of your story',
        key='genre_input',
        placeholder='Enter the theme of which you want the story to be', 
        disabled=st.session_state.genreBox_state
    )
    col_2.write('')
    col_2.write('')
    col_2_cols = col_2.columns([0.5, 6, 0.5])
    col_2_cols[1].button(
        ':arrows_counterclockwise: &nbsp; Clear', 
        key='clear_btn',
        on_click=lambda: setattr(st.session_state, "genre_input", ''),
        disabled=st.session_state.genreBox_state
    )
    col_3.write('')
    col_3.write('')

    # ì²˜ìŒ ì‹œì‘! ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ get_output í•¨ìˆ˜ê°€ ì‹¤í–‰.
    # ì‹œì‘! ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ get_output => get_story_and_image => add_new_data ìˆœì„œë¡œ ì‹¤í–‰ëœë‹¤.
    # ê·¸ í›„ ì•„ë˜ì˜ generate_contentê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ í™”ë©´ì— ì²«ë²ˆì§¸ ìŠ¤í† ë¦¬ë¥¼ ì¶œë ¥í•œë‹¤.
    begin = col_3.button(
        'ì‹œì‘!',
        on_click=get_output, args=[st.empty()], kwargs={'genre': st.session_state.genre_input},
        disabled=st.session_state.genreBox_state
    )

# í™”ë©´ì— ê° íŒŒíŠ¸ë¥¼ ìˆœì„œëŒ€ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
# ì—¬ê¸°ì„œ ê° oidëŠ” ê° Partì˜ key ê°’ ì—­í• ì„ í•˜ëŠ” ë‚œìˆ˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
# oidëŠ” ë§ ê·¸ëŒ€ë¡œ ë‚œìˆ˜ì´ë¯€ë¡œ 'c4022774-5f2e-4edc-bbbe-cbeed5b98b70' ì´ëŸ° ì„ì˜ì˜ ê°’ì„ ê°€ì§‘ë‹ˆë‹¤.
# ëª¨ë“  oid(Part / ìŠ¤í† ë¦¬)ë¥¼ ë°˜ë³µë¬¸ì„ í†µí•´ì„œ í™”ë©´ì— Part1, Part2 ...ì™€ ê°™ì´ ìˆœì°¨ì ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
for oid in st.session_state['oid_list']:
    data = st.session_state['data_dict'][oid]
    story = data[0]
    decisionQuestion = data[1]
    chioces = data[2]
    img = data[3]
    # ê° ìŠ¤í† ë¦¬ë¥¼ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜. ì´ë•Œ ì§€ë‚˜ê°„ ìŠ¤í† ë¦¬ëŠ” í™”ë©´ì—ì„œ ë‹«ê±°ë‚˜ ì„ íƒì§€ ë²„íŠ¼ì„ ë¹„í™œì„±í™” í•˜ëŠ” ë“±ì˜ ì—­í• ë„ ìˆ˜í–‰.
    generate_content(story, decisionQuestion, chioces, img, oid)